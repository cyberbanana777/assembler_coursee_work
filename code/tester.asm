.include "m328Pdef.inc" ; Подключаем файл с определениями

.cseg                   ; Начало сегмента кода
.org 0x0000            ; Устанавливаем начало программы по адресу 0

    rjmp main          ; Переход на главную программу

main:
    ; ИНИЦИАЛИЗАЦИЯ СТЕКА (ОБЯЗАТЕЛЬНО!)
    ldi r16, high(RAMEND) ; Загружаем старший байт конца RAM
    out SPH, r16
    ldi r16, low(RAMEND)  ; Загружаем младший байт конца RAM
    out SPL, r16

    ; НАСТРОЙКА ПИНОВ НА ВЫХОД
    sbi DDRD, PD5      ; Пин D5 (Зеленый) как выход
    sbi DDRD, PD6      ; Пин D6 (Красный) как выход
    sbi DDRB, PB1      ; Пин D9 (Синий) как выход

    ; НАСТРОЙКА ТАЙМЕРА0 (ДЛЯ PINS D5 и D6)
    ; Режим: Fast PWM 8-bit, неинверсный ШИМ
    ldi r16, (1<<COM0A1) | (1<<COM0B1) | (1<<WGM01) | (1<<WGM00)
    out TCCR0A, r16
    ; Предделитель: 64 (частота ШИМ ~976.56 Гц)
    ldi r16, (1<<CS01) | (1<<CS00)
    out TCCR0B, r16

    ; НАСТРОЙКА ТАЙМЕРА1 (ДЛЯ PIN D9)
    ; Режим: Fast PWM 8-bit, неинверсный ШИМ
    ldi r16, (1<<COM1A1) | (1<<WGM10)
    sts TCCR1A, r16
    ; Предделитель: 64 (частота ШИМ ~490.20 Гц)
    ldi r16, (1<<WGM12) | (1<<CS11) | (1<<CS10)
    sts TCCR1B, r16

    ; УСТАНОВКА ЯРКОСТИ 50% ДЛЯ ВСЕХ ЦВЕТОВ
    ; Значение 128 из 255 = ~50% (255/2 = 127.5 ≈ 128)
    ldi r16, 128       ; Загружаем значение половины яркости

    out OCR0A, r16     ; Устанавливаем для КРАСНОГО (D6)
    out OCR0B, r16     ; Устанавливаем для ЗЕЛЕНОГО (D5) 
    sts OCR1AL, r16    ; Устанавливаем для СИНЕГО (D9)

    ; БЕСКОНЕЧНЫЙ ЦИКЛ (НИЧЕГО НЕ ДЕЛАЕМ, ШИМ РАБОТАЕТ САМ)
loop:
    rjmp loop
